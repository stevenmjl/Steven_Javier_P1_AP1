@page "/Aportes/Create"
@rendermode InteractiveServer
@inject AportesService aportesService
@inject NavigationManager Navigation

<PageTitle>Registrar Aportes</PageTitle>

<EditForm Model="Aporte" OnValidSubmit="Guardar">
<DataAnnotationsValidator /> <ValidationSummary />

    @if (!string.IsNullOrEmpty(MensajeError)) {
        <div class="alert alert-danger">@MensajeError</div>
    }

    @if (!string.IsNullOrEmpty(MensajeExito)) {
        <div class="alert alert-success">@MensajeExito</div>
    }

    <div class="container">
        <div class="card shadow-lg">
            @* Título *@
            <div class="card-header text-white text-center">
                <div class="bg-success rounded">
                    <h1>Registro de Aportes</h1>
                </div>
            </div>

            @* Cuerpo de página *@
            <div class="card-body">
                @* ID *@
                <div class="mb-3 col-2">
                    <label class="form-label" for="ModeloId">ID:</label>
                    <InputNumber id="ModeloId" class="form-control text-left" readonly
                                 @bind-Value="UltimoAporte"></InputNumber>
                </div>

                @* Persona *@
                <div class="mb-3 col-4">
                    <label class="form-label" for="Persona">Persona:</label>
                    <InputText id="Persona" class="form-control"
                               @bind-Value="Aporte.Persona" placeholder="Ej: Pablo Sosa">
                    </InputText>
                    <ValidationMessage For="@(() => Aporte.Persona)"></ValidationMessage>
                </div>

                @* Observacion *@
                <div class="mb-3">
                    <label class="form-label" for="Observacion">Observacion:</label>
                    <InputText id="Observacion" class="form-control"
                               @bind-Value="Aporte.Observacion" placeholder="Ej: Caridad de enero">
                    </InputText>
                    <ValidationMessage For="@(() => Aporte.Observacion)"></ValidationMessage>
                </div>

                @* Monto *@
                <div class="mb-3 col-2">
                    <label class="form-label" for="Monto">Monto:</label>
                    <InputNumber id="Monto" class="form-control"
                                 @bind-Value="Aporte.Monto"></InputNumber>
                    <ValidationMessage For="@(() => Aporte.Monto)"></ValidationMessage>
                </div>
            </div>

            @* Botones Crear y Volver *@
            <div class="card-footer d-flex justify-content-center">
                <button type="submit" class="btn btn-success">
                    Crear
                </button>
                <a class="btn btn-secondary" href="/Aportes/Index">
                    Volver
                </a>
            </div>
        </div>
    </div>
</EditForm>

@code {
    public Aportes Aporte { get; set; } = new Aportes();
    private int UltimoAporte;
    private string MensajeError = "";
    private string MensajeExito = "";

    protected override async Task OnInitializedAsync()
    {
        UltimoAporte = 1 + await aportesService.UltimoId();
    }

    public async Task Guardar()
    {
        MensajeError = "";
        MensajeExito = "";

        if (!await Validar())
        {
            var nuevo = await aportesService.Guardar(Aporte);
            if (nuevo)
            {
                MensajeExito = $"Aporte {Aporte.Observacion} ha sido creado correctamente.";
                Aporte = new Aportes();
                UltimoAporte = 1 + await aportesService.UltimoId();
            }
            else
            {
                MensajeError = "El aporte no se ha podido crear correctamente.";
            }
        }
        else
        {
            MensajeError = "Ya existe un aporte con la misma descripción.";
        }
    }

    public async Task<bool> Validar()
    {
        var existe = await aportesService.Existe(Aporte.AportesId, Aporte.Persona, Aporte.Observacion);
        return existe;
    }
}